name: ğŸ” Security Scan / ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scan / ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø£Ù…Ù†ÙŠ Ø£Ø³Ø¨ÙˆØ¹ÙŠ
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Security Scanning / ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code / ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection
        
    - name: ğŸ Set up Python / Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: ğŸ“¦ Install dependencies / ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      run: |
        python -m pip install --upgrade pip
        pip install detect-secrets
        pip install truffleHog
        
    - name: ğŸ” Scan for secrets with detect-secrets / ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… detect-secrets
      run: |
        echo "ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø±..."
        echo "ğŸ” Starting secret scan..."
        
        # Create baseline if it doesn't exist / Ø¥Ù†Ø´Ø§Ø¡ baseline Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if [ ! -f .secrets.baseline ]; then
          detect-secrets scan --baseline .secrets.baseline
        fi
        
        # Scan for new secrets / ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        detect-secrets scan --baseline .secrets.baseline --exclude-files analysis/
        
        # Audit results / Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        detect-secrets audit .secrets.baseline
        
    - name: ğŸš¨ Check for exposed AWS credentials / ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª AWS Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©
      run: |
        echo "ğŸš¨ ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ AWS..."
        echo "ğŸš¨ Checking for AWS credentials..."
        
        # Check for AWS Access Key IDs / ÙØ­Øµ Ù…Ø¹Ø±ÙØ§Øª Ù…ÙØ§ØªÙŠØ­ AWS
        if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=.git --exclude="*.log" --exclude-dir=analysis; then
          echo "âŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…ÙØ§ØªÙŠØ­ AWS Ù…ÙƒØ´ÙˆÙØ©!"
          echo "âŒ Exposed AWS keys detected!"
          exit 1
        fi
        
        # Check for AWS Secret Access Keys / ÙØ­Øµ Ù…ÙØ§ØªÙŠØ­ AWS Ø§Ù„Ø³Ø±ÙŠØ©
        if grep -r "[0-9a-zA-Z/+]\{40\}" . --exclude-dir=.git --exclude="*.log" --exclude-dir=analysis | grep -E "(aws_secret_access_key|AWS_SECRET_ACCESS_KEY)"; then
          echo "âŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…ÙØ§ØªÙŠØ­ AWS Ø³Ø±ÙŠØ© Ù…ÙƒØ´ÙˆÙØ©!"
          echo "âŒ Exposed AWS secret keys detected!"
          exit 1
        fi
        
        echo "âœ… Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…ÙØ§ØªÙŠØ­ AWS Ù…ÙƒØ´ÙˆÙØ©"
        echo "âœ… No exposed AWS keys detected"
        
    - name: ğŸ” Check for other sensitive patterns / ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· Ø­Ø³Ø§Ø³Ø© Ø£Ø®Ø±Ù‰
      run: |
        echo "ğŸ” ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· Ø­Ø³Ø§Ø³Ø© Ø£Ø®Ø±Ù‰..."
        echo "ğŸ” Checking for other sensitive patterns..."
        
        # GitHub tokens / Ø±Ù…ÙˆØ² GitHub
        if grep -r "ghp_[a-zA-Z0-9]\{36\}" . --exclude-dir=.git --exclude="*.log" --exclude-dir=analysis; then
          echo "âŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø±Ù…ÙˆØ² GitHub Ù…ÙƒØ´ÙˆÙØ©!"
          echo "âŒ Exposed GitHub tokens detected!"
          exit 1
        fi
        
        # Google API keys / Ù…ÙØ§ØªÙŠØ­ Google API
        if grep -r "AIza[0-9A-Za-z_-]\{35\}" . --exclude-dir=.git --exclude="*.log" --exclude-dir=analysis; then
          echo "âŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…ÙØ§ØªÙŠØ­ Google API Ù…ÙƒØ´ÙˆÙØ©!"
          echo "âŒ Exposed Google API keys detected!"
          exit 1
        fi
        
        # Private keys / Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø®Ø§ØµØ©
        if grep -r "-----BEGIN.*PRIVATE KEY-----" . --exclude-dir=.git --exclude="*.log" --exclude-dir=analysis; then
          echo "âŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…ÙØ§ØªÙŠØ­ Ø®Ø§ØµØ© Ù…ÙƒØ´ÙˆÙØ©!"
          echo "âŒ Exposed private keys detected!"
          exit 1
        fi
        
        echo "âœ… Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£Ù†Ù…Ø§Ø· Ø­Ø³Ø§Ø³Ø© Ø£Ø®Ø±Ù‰"
        echo "âœ… No other sensitive patterns detected"
        
    - name: ğŸ“Š Check file sizes / ÙØ­Øµ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        echo "ğŸ“Š ÙØ­Øµ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª..."
        echo "ğŸ“Š Checking file sizes..."
        
        # Find files larger than 5MB / Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø£ÙƒØ¨Ø± Ù…Ù† 5MB
        large_files=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./analysis/*")
        
        if [ -n "$large_files" ]; then
          echo "âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª ÙƒØ¨ÙŠØ±Ø©:"
          echo "âš ï¸ Large files found:"
          echo "$large_files"
          
          # Check if they're tracked by Git LFS / Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØªØ¨Ø¹Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Git LFS
          for file in $large_files; do
            if ! git lfs ls-files | grep -q "$file"; then
              echo "âŒ Ø§Ù„Ù…Ù„Ù $file ÙƒØ¨ÙŠØ± ÙˆÙ„ÙŠØ³ ÙÙŠ Git LFS!"
              echo "âŒ File $file is large but not in Git LFS!"
              exit 1
            fi
          done
        fi
        
        echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ Git LFS"
        echo "âœ… All large files are in Git LFS"
        
    - name: ğŸ§¹ Check filename safety / ÙØ­Øµ Ø£Ù…Ø§Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        echo "ğŸ§¹ ÙØ­Øµ Ø£Ù…Ø§Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª..."
        echo "ğŸ§¹ Checking filename safety..."
        
        # Check for unsafe characters in filenames / ÙØ­Øµ Ø§Ù„Ø±Ù…ÙˆØ² ØºÙŠØ± Ø§Ù„Ø¢Ù…Ù†Ø© ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
        unsafe_files=$(find . -name "*[[:space:]]*" -o -name "*+*" -o -name "*=*" -o -name "*?*" -o -name "*#*" -o -name "*%*" -o -name "*&*" | grep -v ".git" | grep -v "analysis" || true)
        
        if [ -n "$unsafe_files" ]; then
          echo "âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø¨Ø£Ø³Ù…Ø§Ø¡ ØºÙŠØ± Ø¢Ù…Ù†Ø©:"
          echo "âš ï¸ Files with unsafe names found:"
          echo "$unsafe_files"
          echo "ğŸ’¡ ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª"
          echo "ğŸ’¡ Consider renaming these files"
        else
          echo "âœ… Ø¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¢Ù…Ù†Ø©"
          echo "âœ… All filenames are safe"
        fi
        
    - name: ğŸ“ Generate security report / Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù†
      if: always()
      run: |
        echo "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù†..."
        echo "ğŸ“ Generating security report..."
        
        cat > security-report.md << 'EOF'
        # Security Scan Report / ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
        
        **Date/Ø§Ù„ØªØ§Ø±ÙŠØ®:** $(date)
        **Repository/Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:** ${{ github.repository }}
        **Branch/Ø§Ù„ÙØ±Ø¹:** ${{ github.ref_name }}
        
        ## Summary / Ø§Ù„Ù…Ù„Ø®Øµ
        
        - âœ… Secret scan completed / ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø±
        - âœ… File size check completed / ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØ­Øµ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª  
        - âœ… Filename safety check completed / ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙØ­Øµ Ø£Ù…Ø§Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
        
        ## Recommendations / Ø§Ù„ØªÙˆØµÙŠØ§Øª
        
        1. Regularly rotate sensitive credentials / ØªØ¯ÙˆÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ù…
        2. Use Git LFS for files > 5MB / Ø§Ø³ØªØ®Ø¯Ø§Ù… Git LFS Ù„Ù„Ù…Ù„ÙØ§Øª Ø£ÙƒØ¨Ø± Ù…Ù† 5MB
        3. Avoid special characters in filenames / ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø®Ø§ØµØ© ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
        
        EOF
        
    - name: ğŸ“¤ Upload security report / Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù†
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        retention-days: 30

  notify-on-failure:
    name: ğŸš¨ Notify on Security Issues / Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ©
    runs-on: ubuntu-latest
    needs: security-scan
    if: failure()
    
    steps:
    - name: ğŸš¨ Security Alert / ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ
      run: |
        echo "ğŸš¨ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹!"
        echo "ğŸš¨ Security issues detected in repository!"
        echo "ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙØ­Øµ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©"
        echo "Please review scan logs and take appropriate action"